name: XcodeBuild

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  spin_up:
    runs-on: [self-hosted, master-runner]
    steps:
    - name: Spin Up VM
      id: spin_up
      uses: jeff-vincent/orka-actions-spin-up@master
      with:
        orkaIP: http://10.221.188.100
        orkaUser: <orka_user>
        orkaPass: <orka_pass>
        orkaBaseImage: actions_agent.img
        githubUser: <gh_user>
        githubPat: <gh_pat>
        githubRepoName: <gh_repo_name>
    outputs:
      uniqueVMActionsTag: ${{ steps.spin_up.outputs.uniqueVMActionsTag }}
      vmName: ${{ steps.spin_up.outputs.vmName }}
      orkaNodeName: ${{ steps.spin_up.outputs.orkaNodeName }}
        
        
  native_job:
    needs: spin_up
    runs-on: [self-hosted, "${{ needs.spin_up.outputs.uniqueVMActionsTag }}"]
    steps:
    - name: Native Job
      id: native_job
      run: |
        echo "I'm running on ${{ needs.spin_up.outputs.uniqueVMActionsTag }}"
        system_profiler
      
  tear_down:
    if: always()
    needs: [spin_up, native_job]
    runs-on: [self-hosted, master-runner]
    steps:
    - name: Tear Down VM
      id: tear_down
      uses: jeff-vincent/orka-actions-tear-down@master
      with:
        orkaUser: <orka_user>
        orkaPass: <orka_pass>
        vmName: ${{ needs.spin_up.outputs.vmName }}
        githubUser: <gh_user>
        githubPat: <gh_pat>
        githubRepoName: <gh_repo_name>